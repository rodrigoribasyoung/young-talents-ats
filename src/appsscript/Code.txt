/**
 * INTEGRAÇÃO YOUNG ATS -> FIREBASE
 * Este script monitora novas linhas na planilha e envia para o Firestore.
 */

// CONFIGURAÇÃO DO FIREBASE (Pegue estes dados no Console do Firebase)
const FIREBASE_CONFIG = {
  email: "seu-email-de-servico@projeto.iam.gserviceaccount.com",
  key: "-----BEGIN PRIVATE KEY-----\n...\n-----END PRIVATE KEY-----\n",
  projectId: "seu-project-id"
};

const FIRESTORE_URL = `https://firestore.googleapis.com/v1/projects/${FIREBASE_CONFIG.projectId}/databases/(default)/documents`;

/**
 * Função principal disparada pelo gatilho 'Ao enviar formulário' ou 'Ao alterar'
 */
function syncRowToFirestore(e) {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
  
  // Se foi acionado por envio de formulário, usamos o range do evento. 
  // Se não, pegamos a última linha.
  const row = e && e.range ? e.range.getRow() : sheet.getLastRow();
  
  // Mapeamento das colunas (Assumindo ordem do prompt)
  // Ajuste os índices conforme sua planilha real (começa em 1)
  const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
  const rowData = sheet.getRange(row, 1, 1, sheet.getLastColumn()).getValues()[0];
  
  // Cria objeto do candidato
  const candidato = {};
  
  headers.forEach((header, index) => {
    // Normaliza a chave (remove acentos, espaços, lowercase)
    let key = normalizeKey(header);
    candidato[key] = rowData[index];
  });
  
  // Adiciona campos padrão do sistema
  candidato['etapa'] = 'Inscrito';
  candidato['dataImportacao'] = new Date().toISOString();
  
  // Envia para o Firestore
  sendToFirestore(candidato);
}

function normalizeKey(text) {
  // Mapa de conversão simples baseado no seu prompt
  if(text.includes("Nome completo")) return "nome";
  if(text.includes("E-mail")) return "email";
  if(text.includes("telefone")) return "telefone";
  if(text.includes("Cidade")) return "cidade";
  if(text.includes("Áreas de interesse")) return "areaInteresse";
  if(text.includes("Cargo")) return "cargo";
  
  // Fallback para camelCase genérico
  return text.normalize("NFD").replace(/[\u0300-\u036f]/g, "")
    .toLowerCase()
    .replace(/[^a-zA-Z0-9]+(.)/g, (m, chr) => chr.toUpperCase());
}

function sendToFirestore(data) {
  const token = getServiceAccountToken();
  const collectionName = "artifacts/young-ats/public/data/candidates"; // Ajuste conforme a regra de segurança
  
  // Estrutura do Payload Firestore REST API
  const firestoreFields = {};
  for (const key in data) {
    firestoreFields[key] = { stringValue: String(data[key] || "") };
  }
  
  const payload = {
    fields: firestoreFields
  };
  
  const options = {
    method: "post",
    contentType: "application/json",
    headers: { Authorization: "Bearer " + token },
    payload: JSON.stringify(payload),
    muteHttpExceptions: true
  };
  
  const response = UrlFetchApp.fetch(`${FIRESTORE_URL}/${collectionName}`, options);
  Logger.log(response.getContentText());
}

/**
 * Gera token OAuth2 para conta de serviço (Requer biblioteca OAuth2 no AppScript ou implementação manual JWT)
 * *Nota simplificada*: Para produção, recomenda-se usar a biblioteca 'OAuth2' ID: 1B7FSrk5Zi6L1rSxxTDgDEUsPzlukDsi4KGuTMorsTQHhGBzBkMun4iDF
 */
function getServiceAccountToken() {
  // Implementação placeholder. 
  // Em produção, adicione a biblioteca OAuth2 e configure o serviço.
  // Veja documentação: https://github.com/googleworkspace/apps-script-oauth2
  return "TOKEN_PLACEHOLDER"; 
}